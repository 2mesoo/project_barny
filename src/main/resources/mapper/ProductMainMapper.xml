<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.bit.ex.mapper.ProductMainMapper">
    <select id="getList" resultType="edu.bit.ex.vo.ProductMainVO">
        <![CDATA[
			select product_id, product_name, price 
			from product 
			where category_num = 1
        ]]>
    </select>

    <select id="getList1" resultType="edu.bit.ex.vo.ProductMainVO">
        <![CDATA[
			select product_id, product_name, price 
			from product 
			where category_num = 2
        ]]>
    </select>

    <select id="getList2" resultType="edu.bit.ex.vo.ProductMainVO">
        <![CDATA[
			select product_id, product_name, price 
			from product 
			where category_num = 3
        ]]>
    </select>

    <select id="read" resultType="edu.bit.ex.vo.ProductMainVO">
        <![CDATA[
      		select product_id, product_name, price 
      		from product
      		where product_id = #{product_id}
    	]]>
    </select>

    <!--후기 리스트-->
    <select id="getListReview" resultType="edu.bit.ex.vo.ProductMainVO">
        <![CDATA[
        select DISTINCT b.board_id, b.b_date, b.b_title, b.b_content, b.b_hit, l.like_count, m.nickname from barny_board b, product p, b_like l, member m where b.product_id= #{product_id} and l.board_id = b.board_id and m.member_idx = b.member_idx order by b.b_date desc
        ]]>
    </select>
    <!--후기 히트 업뎃-->
    <update id="updateHit">
        <![CDATA[
           update barny_board set b_hit = b_hit + 1 where board_id = #{board_id}
        ]]>
    </update>
    <!--후기 쓰기-->
    <insert id="writeReview">
        <![CDATA[
        INSERT ALL
        INTO barny_board (board_id, b_date, b_title, b_content, board_type_id, member_idx, b_group, product_id) 
        VALUES(board_id_seq.NEXTVAL, sysdate, #{b_title}, #{b_content}, 2, #{member_idx}, board_id_seq.currval, #{product_id})
        
        INTO b_like (board_id, like_count) VALUES(board_id_seq.currval, 0)

        select*from dual
        ]]>

    </insert>

    <insert id="insertList">

        <![CDATA[
        insert into image (image_id, product_id, board_id, image_name, image_extension, image_route, image_uuid) values (image_id_seq.NEXTVAL, #{product_id}, board_id_seq.currval, #{image_name}, #{image_extension}, #{image_route}, #{image_uuid} )
        ]]>

    </insert>

    <!--후기 페이징-->

    <select id="getTotalCount" resultType="int" parameterType="map">
        <![CDATA[
        select count(DISTINCT b.board_id) from barny_board b, product p, b_like l, member m where b.product_id= #{product_id} and l.board_id = b.board_id and m.member_idx = b.member_idx
           ]]>
    </select>

    <select id="getListWithPaging" resultType="edu.bit.ex.vo.ProductMainVO" parameterType="map">
        <!-- ROWNUM: sql이 실행된 결과에 넘버링을 해줌 -->
        <![CDATA[
            SELECT * FROM ( 
                   SELECT ROWNUM AS RNUM, A.* FROM (
                            SELECT
                            DISTINCT b.board_id, b.b_date, b.b_title, b.b_content, b.b_hit, l.like_count, m.nickname
                              FROM
                              barny_board b, product p, b_like l, member m
                where b.product_id= #{product_id} and l.board_id = b.board_id and m.member_idx = b.member_idx order by b.b_date desc                  
                ) A WHERE ROWNUM <= #{cri.pageNum} * #{cri.amount}
              ) WHERE RNUM > (#{cri.pageNum}-1) * #{cri.amount}
              ]]>

    </select>


</mapper>